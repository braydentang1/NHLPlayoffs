# NHLPlayoffs
A model that aims to predict the outcome of a NHL playoff series before the first game is played. 

Sits at 0.65742 log loss using data from 2006 and onwards.

The problem with this dataset mostly concerns the dimension of the dataset (relative to how small the dataset is). However, feature reduction/extraction techniques tried so far have not been able to improve the model, besides the embedded feature selection present in all elastic net models via. penalization of the likelihood.

Methods used that did not improve the model:
1) PCA for dimension reduction.
2) Calibration via. platt scaling.
3) Recursive feature elimination.

Other methods potentially useful:

1) Boruta
2) SHAP
3) Null importances; highly correlated features will influence variable importance scores due to conflation. It might be advantageous to correct for said correlation via. permutation based methods, in combination with external validation i.e. recursive feature elimination.

Folder Descriptions:
-----
1. **All Team Stats:** .csv files pulled from corsica.hockey. Used in the .R file CorsicaAllTeamStats, located in the Scraping Scripts and Template.
2. **Evolving Hockey:** .csv files pulled from evolvinghockey. Only the folder that contains GAR/WAR is used. Used in the .R file EvolvingHockey WAR, located in the Scraping Scripts and Template.
3. **Game Score:** .csv files pulled from corsica.hockey. Used in the .R file CorsicaGameScore. 
4. **Modelling:** .R files where the actual modelling scripts can be found. 
5. **Required Data Sets:** All datasets needed to run the model (the .R file in 4). These .csv files are fully processed files for all 210 NHL playoff series since 2006 using data scraped from various webpages. These .csv files can be generated by running each .R file in folder 6.
6. **Scraping Scripts and Template:** All .R files used to scrape the webpages and to proceess the data in a format that allows for making predictions. <br> The dataset itself is processed so that one row/observation is the difference between each variable, from the higher seeds perspective. Note that this decision has no theoretical basis and that a ratio, sum, product, or other transformation could have been used instead. I just thought that a difference made the most intuitive sense. Another note: feature engineering becomes harder when doing this since the data is preprocessed as a difference. <br> There are Excel template files that requires one to fill out a few columns; namely the two teams involved in the series, the year, the round, the highest seed betweeen the two teams (for processing), and the conference. For the other template file, start and end dates are required for each playoff round. Nothing is actually done in spreadsheets, this is purely to get the data in a usable format and to help in function calls/html links. Every .R scraping file pulls this template in and builds off it. 

How To Run:
-----
_Using the .csv files already processed in the folder "Required Data Sets":_

1. Download the repository.
2. Open up the .R file in the Modelling folder, called "Bagged Elastic Net.r". 
3. Change the working directory (the first line in the script) to some arbitrary folder (it doesn't matter what folder; this is purely for status checks on the process when running in parallel).
4. In the part of the script with title "Read Data In", change each file path to each respective file in the folder "Required Data Sets" located in the repository.
5. Run the script.

TODO:
-----
- [x] 1. Finish the scraping automation.
- [x] 2. Redo the modelling script. In particular, the for loops are awful and there is a lot of code that can be improved.
- [x] 3. Add 2013 data. Improve the model below 0.67 log loss.
- [x] 4/5. Document how to run the scripts from scratch + other critical decisions.
- [ ] 4/5. Shiny app.

Credits:
-----
Data Pulled From:

https://www.corsicahockey.com/ <br>
http://www.puckon.net/ <br>
https://evolving-hockey.com/ <br>
http://www.espn.com/ <br>
https://www.nhl.com/ <br>
https://www.oddsportal.com/ <br>
https://www.naturalstattrick.com/ <br>
https://www.hockey-reference.com/

Credit for the ELO calculator formulas goes to the owner of HockeyAnalytics. The source page can be found here:

http://hockeyanalytics.com/2016/07/elo-ratings-for-the-nhl/

A big thanks to my good friend Mr. Riley Peters for spotting the logic flaws in some of the pre processing as well as supplying large amounts of suggestions on the game of hockey. 
